from web3 import Web3
import json
from django.conf import settings
import os

ABI_PATH = os.path.join(settings.BASE_DIR, 'blockchain', 'blood_donation.json')

with open(ABI_PATH, 'r') as abi_file:
    contract_abi = json.load(abi_file)


contract_bytecode = "608060405234801561001057600080fd5b506119e0806100206000396000f3fe608060405234801561001057600080fd5b50600436106100575760003560e01c80632abfab4d1461005c5780632fcfb7791461007a578063d091ff8e146100aa578063e25f8416146100c6578063f8626af8146100e4575b600080fd5b61006461011a565b6040516100719190610d2b565b60405180910390f35b610094600480360381019061008f9190610d86565b610120565b6040516100a19190610fe0565b60405180910390f35b6100c460048036038101906100bf9190611163565b6104d7565b005b6100ce61071f565b6040516100db9190610fe0565b60405180910390f35b6100fe60048036038101906100f99190610d86565b610a64565b60405161011197969594939291906112ce565b60405180910390f35b60015481565b6060600080600190505b60015481116101715783600080838152602001908152602001600020600001540361015e57818061015a90611388565b9250505b808061016990611388565b91505061012a565b5060008167ffffffffffffffff81111561018e5761018d61100c565b5b6040519080825280602002602001820160405280156101c757816020015b6101b4610cd3565b8152602001906001900390816101ac5790505b509050600080600190505b60015481116104cb578560008083815260200190815260200160002060000154036104b8576000808281526020019081526020016000206040518060e00160405290816000820154815260200160018201805461022e906113ff565b80601f016020809104026020016040519081016040528092919081815260200182805461025a906113ff565b80156102a75780601f1061027c576101008083540402835291602001916102a7565b820191906000526020600020905b81548152906001019060200180831161028a57829003601f168201915b505050505081526020016002820180546102c0906113ff565b80601f01602080910402602001604051908101604052809291908181526020018280546102ec906113ff565b80156103395780601f1061030e57610100808354040283529160200191610339565b820191906000526020600020905b81548152906001019060200180831161031c57829003601f168201915b50505050508152602001600382018054610352906113ff565b80601f016020809104026020016040519081016040528092919081815260200182805461037e906113ff565b80156103cb5780601f106103a0576101008083540402835291602001916103cb565b820191906000526020600020905b8154815290600101906020018083116103ae57829003601f168201915b505050505081526020016004820180546103e4906113ff565b80601f0160208091040260200160405190810160405280929190818152602001828054610410906113ff565b801561045d5780601f106104325761010080835404028352916020019161045d565b820191906000526020600020905b81548152906001019060200180831161044057829003601f168201915b505050505081526020016005820160009054906101000a900460ff1615151515815260200160068201548152505083838151811061049e5761049d611430565b5b602002602001018190525081806104b490611388565b9250505b80806104c390611388565b9150506101d2565b50819350505050919050565b6000871161051a576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610511906114ab565b60405180910390fd5b600086511161055e576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161055590611517565b60405180910390fd5b60008551116105a2576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161059990611583565b60405180910390fd5b60008451116105e6576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016105dd906115ef565b60405180910390fd5b600083511161062a576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016106219061165b565b60405180910390fd5b6001600081548092919061063d90611388565b9190505550600080600060015481526020019081526020016000209050878160000181905550868160010190816106749190611827565b50858160020190816106869190611827565b50848160030190816106989190611827565b50838160040190816106aa9190611827565b50828160050160006101000a81548160ff021916908315150217905550818160060181905550876001547f1493ee4c10f6615dc1f7b46bd4a2b54989e1b8992c7db929abb79174b41200f489898989898960405161070d969594939291906118f9565b60405180910390a35050505050505050565b6060600060015467ffffffffffffffff81111561073f5761073e61100c565b5b60405190808252806020026020018201604052801561077857816020015b610765610cd3565b81526020019060019003908161075d5790505b5090506000600190505b6001548111610a5c576000808281526020019081526020016000206040518060e0016040529081600082015481526020016001820180546107c2906113ff565b80601f01602080910402602001604051908101604052809291908181526020018280546107ee906113ff565b801561083b5780601f106108105761010080835404028352916020019161083b565b820191906000526020600020905b81548152906001019060200180831161081e57829003601f168201915b50505050508152602001600282018054610854906113ff565b80601f0160208091040260200160405190810160405280929190818152602001828054610880906113ff565b80156108cd5780601f106108a2576101008083540402835291602001916108cd565b820191906000526020600020905b8154815290600101906020018083116108b057829003601f168201915b505050505081526020016003820180546108e6906113ff565b80601f0160208091040260200160405190810160405280929190818152602001828054610912906113ff565b801561095f5780601f106109345761010080835404028352916020019161095f565b820191906000526020600020905b81548152906001019060200180831161094257829003601f168201915b50505050508152602001600482018054610978906113ff565b80601f01602080910402602001604051908101604052809291908181526020018280546109a4906113ff565b80156109f15780601f106109c6576101008083540402835291602001916109f1565b820191906000526020600020905b8154815290600101906020018083116109d457829003601f168201915b505050505081526020016005820160009054906101000a900460ff1615151515815260200160068201548152505082600183610a2d9190611976565b81518110610a3e57610a3d611430565b5b60200260200101819052508080610a5490611388565b915050610782565b508091505090565b6000602052806000526040600020600091509050806000015490806001018054610a8d906113ff565b80601f0160208091040260200160405190810160405280929190818152602001828054610ab9906113ff565b8015610b065780601f10610adb57610100808354040283529160200191610b06565b820191906000526020600020905b815481529060010190602001808311610ae957829003601f168201915b505050505090806002018054610b1b906113ff565b80601f0160208091040260200160405190810160405280929190818152602001828054610b47906113ff565b8015610b945780601f10610b6957610100808354040283529160200191610b94565b820191906000526020600020905b815481529060010190602001808311610b7757829003601f168201915b505050505090806003018054610ba9906113ff565b80601f0160208091040260200160405190810160405280929190818152602001828054610bd5906113ff565b8015610c225780601f10610bf757610100808354040283529160200191610c22565b820191906000526020600020905b815481529060010190602001808311610c0557829003601f168201915b505050505090806004018054610c37906113ff565b80601f0160208091040260200160405190810160405280929190818152602001828054610c63906113ff565b8015610cb05780601f10610c8557610100808354040283529160200191610cb0565b820191906000526020600020905b815481529060010190602001808311610c9357829003601f168201915b5050505050908060050160009054906101000a900460ff16908060060154905087565b6040518060e001604052806000815260200160608152602001606081526020016060815260200160608152602001600015158152602001600081525090565b6000819050919050565b610d2581610d12565b82525050565b6000602082019050610d406000830184610d1c565b92915050565b6000604051905090565b600080fd5b600080fd5b610d6381610d12565b8114610d6e57600080fd5b50565b600081359050610d8081610d5a565b92915050565b600060208284031215610d9c57610d9b610d50565b5b6000610daa84828501610d71565b91505092915050565b600081519050919050565b600082825260208201905092915050565b6000819050602082019050919050565b610de881610d12565b82525050565b600081519050919050565b600082825260208201905092915050565b60005b83811015610e28578082015181840152602081019050610e0d565b60008484015250505050565b6000601f19601f8301169050919050565b6000610e5082610dee565b610e5a8185610df9565b9350610e6a818560208601610e0a565b610e7381610e34565b840191505092915050565b60008115159050919050565b610e9381610e7e565b82525050565b600060e083016000830151610eb16000860182610ddf565b5060208301518482036020860152610ec98282610e45565b91505060408301518482036040860152610ee38282610e45565b91505060608301518482036060860152610efd8282610e45565b91505060808301518482036080860152610f178282610e45565b91505060a0830151610f2c60a0860182610e8a565b5060c0830151610f3f60c0860182610ddf565b508091505092915050565b6000610f568383610e99565b905092915050565b6000602082019050919050565b6000610f7682610db3565b610f808185610dbe565b935083602082028501610f9285610dcf565b8060005b85811015610fce5784840389528151610faf8582610f4a565b9450610fba83610f5e565b925060208a01995050600181019050610f96565b50829750879550505050505092915050565b60006020820190508181036000830152610ffa8184610f6b565b905092915050565b600080fd5b600080fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b61104482610e34565b810181811067ffffffffffffffff821117156110635761106261100c565b5b80604052505050565b6000611076610d46565b9050611082828261103b565b919050565b600067ffffffffffffffff8211156110a2576110a161100c565b5b6110ab82610e34565b9050602081019050919050565b82818337600083830152505050565b60006110da6110d584611087565b61106c565b9050828152602081018484840111156110f6576110f5611007565b5b6111018482856110b8565b509392505050565b600082601f83011261111e5761111d611002565b5b813561112e8482602086016110c7565b91505092915050565b61114081610e7e565b811461114b57600080fd5b50565b60008135905061115d81611137565b92915050565b600080600080600080600060e0888a03121561118257611181610d50565b5b60006111908a828b01610d71565b975050602088013567ffffffffffffffff8111156111b1576111b0610d55565b5b6111bd8a828b01611109565b965050604088013567ffffffffffffffff8111156111de576111dd610d55565b5b6111ea8a828b01611109565b955050606088013567ffffffffffffffff81111561120b5761120a610d55565b5b6112178a828b01611109565b945050608088013567ffffffffffffffff81111561123857611237610d55565b5b6112448a828b01611109565b93505060a06112558a828b0161114e565b92505060c06112668a828b01610d71565b91505092959891949750929550565b600082825260208201905092915050565b600061129182610dee565b61129b8185611275565b93506112ab818560208601610e0a565b6112b481610e34565b840191505092915050565b6112c881610e7e565b82525050565b600060e0820190506112e3600083018a610d1c565b81810360208301526112f58189611286565b905081810360408301526113098188611286565b9050818103606083015261131d8187611286565b905081810360808301526113318186611286565b905061134060a08301856112bf565b61134d60c0830184610d1c565b98975050505050505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b600061139382610d12565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82036113c5576113c4611359565b5b600182019050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b6000600282049050600182168061141757607f821691505b60208210810361142a576114296113d0565b5b50919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b7f496e76616c696420646f6e6f7220494400000000000000000000000000000000600082015250565b6000611495601083611275565b91506114a08261145f565b602082019050919050565b600060208201905081810360008301526114c481611488565b9050919050565b7f496e76616c696420646f6e6f72206e616d650000000000000000000000000000600082015250565b6000611501601283611275565b915061150c826114cb565b602082019050919050565b60006020820190508181036000830152611530816114f4565b9050919050565b7f496e76616c696420626c6f6f642067726f757000000000000000000000000000600082015250565b600061156d601383611275565b915061157882611537565b602082019050919050565b6000602082019050818103600083015261159c81611560565b9050919050565b7f496e76616c696420646f6e6174696f6e20646174650000000000000000000000600082015250565b60006115d9601583611275565b91506115e4826115a3565b602082019050919050565b60006020820190508181036000830152611608816115cc565b9050919050565b7f496e76616c6964206c6f636174696f6e00000000000000000000000000000000600082015250565b6000611645601083611275565b91506116508261160f565b602082019050919050565b6000602082019050818103600083015261167481611638565b9050919050565b60008190508160005260206000209050919050565b60006020601f8301049050919050565b600082821b905092915050565b6000600883026116dd7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff826116a0565b6116e786836116a0565b95508019841693508086168417925050509392505050565b6000819050919050565b600061172461171f61171a84610d12565b6116ff565b610d12565b9050919050565b6000819050919050565b61173e83611709565b61175261174a8261172b565b8484546116ad565b825550505050565b600090565b61176761175a565b611772818484611735565b505050565b5b818110156117965761178b60008261175f565b600181019050611778565b5050565b601f8211156117db576117ac8161167b565b6117b584611690565b810160208510156117c4578190505b6117d86117d085611690565b830182611777565b50505b505050565b600082821c905092915050565b60006117fe600019846008026117e0565b1980831691505092915050565b600061181783836117ed565b9150826002028217905092915050565b61183082610dee565b67ffffffffffffffff8111156118495761184861100c565b5b61185382546113ff565b61185e82828561179a565b600060209050601f831160018114611891576000841561187f578287015190505b611889858261180b565b8655506118f1565b601f19841661189f8661167b565b60005b828110156118c7578489015182556001820191506020850194506020810190506118a2565b868310156118e457848901516118e0601f8916826117ed565b8355505b6001600288020188555050505b505050505050565b600060c08201905081810360008301526119138189611286565b905081810360208301526119278188611286565b9050818103604083015261193b8187611286565b9050818103606083015261194f8186611286565b905061195e60808301856112bf565b61196b60a0830184610d1c565b979650505050505050565b600061198182610d12565b915061198c83610d12565b92508282039050818111156119a4576119a3611359565b5b9291505056fea264697066735822122081fe4862776e9205bcd5e647aa5578b192dac75df05f90aac547bc72366502b364736f6c63430008120033"

# Connect to the local Ganache instance -> network add here
ganache_url = 'http://127.0.0.1:7545'  # Default Ganache URL
w3 = Web3(Web3.HTTPProvider(ganache_url))

# Create a contract instance
contract = w3.eth.contract(bytecode=contract_bytecode, abi=contract_abi)

tx_hash = contract.constructor().transact({'from': "0xac4a4714606C7815d57FdB9b173497eDCD80757d"})
tx_receipt = w3.eth.wait_for_transaction_receipt(tx_hash)
CONTRACT_ADDRESS = tx_receipt["contractAddress"]
print("Contract deployed at:", CONTRACT_ADDRESS)

# deploy_contract()